---
- name: install python-apt
  command: apt install python-apt
  register: install_output
  changed_when: install_output.stdout.find('python-apt is already the newest') == -1
  become: true

- name: install programs
  apt: name={{ item }}
  with_items:
  - curl
  - expect # needed for unbuffer tool used in ranger config creation hack
  - fish
  - git
  - highlight # syntax coloring in ranger file preview
  - nmap
  - python3-pip
  - python3-dev
  - python-pip
  - python-dev
  - sshpass # so that Ansible can log in using password (needed in RPi configuration)
  - ranger
  - tmux
  - tree
  - vim
  - wrk
  - xclip # for tmux-yank
  become: true

- name: upgrade pip for python 3
  pip: name=pip executable=pip3 state=latest
  become: true
  
- name: upgrade pip for python 2
  pip: name=pip executable=pip2 state=latest
  become: true

# before python3 tools so that ptpython will default to python3
- name: install python 2 tools
  pip:
    name: "{{ item }}"
    executable: pip2
    state: latest
    extra_args: --user
  with_items:
  - ptpython
  - pudb

- name: install python tools
  pip:
    name: "{{ item }}"
    executable: pip3
    state: latest
    extra_args: --user
  with_items:
  - httpie
  - ptpython
  - pudb
  - subliminal
  - tox
  - virtualenvwrapper
  - virtualfish

- name: setup tmux plugins
  git: repo=https://github.com/tmux-plugins/tpm dest={{ user_home }}/.tmux/plugins/tpm

- name: set configuration files
  copy: src={{ item }} dest={{ user_home }}
  with_items:
  - .bash_aliases
  - .bashrc
  - .gitconfig
  - .ptpython
  - .tmux.conf
  - .vimrc

- name: create config work and development folders
  file: path={{ item }} state=directory
  with_items:
  - "{{ user_home }}/.config/pudb"
  - "{{ user_home }}/.config/fish"
  - "{{ user_home }}/.config/fish/functions"
  - "{{ user_home }}/.ptpython"
  - "{{ user_home }}/.ssh"
  - "{{ user_home }}/bin"
  - "{{ user_home }}/development"

- name: set pudb config
  copy: src=pudb.cfg dest={{ user_home }}/.config/pudb

- name: set fish config
  copy: src={{ item.src }} dest={{ item.dest }}
  with_items:
  - { src: "fish/config.fish", dest: "{{ user_home }}/.config/fish" }
  - { src: "fish/fish_prompt.fish", dest: "{{ user_home }}/.config/fish/functions" }

- name: create directories for vim plugins
  file: path={{ user_home }}/.vim/{{ item }} state=directory
  with_items:
  - autoload
  - bundle

- name: setup vim plugin system
  get_url:
    url: https://tpo.pe/pathogen.vim
    dest: "{{ user_home }}/.vim/autoload/pathogen.vim"

- name: install vim-jedi
  git:
    repo: https://github.com/davidhalter/jedi-vim.git
    dest: "{{ user_home }}/.vim/bundle/jedi-vim"

- name: create ranger configs
  # unbuffer is used to fake a interactive terminal,
  # because the current stable version of ranger refuses to create a config
  command: unbuffer ranger --copy-config={{ item }}
  with_items:
  - rc
  - scope
  register: config_creation
  changed_when: config_creation.stdout.find('creating:') != -1

- name: ranger settings in rc.conf
  lineinfile:
    dest: "{{ user_home }}/.config/ranger/rc.conf"
    line: "{{ item.line }}" 
    regexp: "{{ item.regexp }}"
  with_items:
  - { line: "map <DELETE>   console delete", regexp: "map <DELETE>"}
  - { line: "set show_hidden true", regexp: "set show_hidden .+" }
  - { line: "set collapse_preview false", regexp: "set collapse_preview" }
  - { line: "set dirname_in_tabs true", regexp: "set dirname_in_tabs" }
  - { line: "set confirm_on_delete multiple", regexp: "set confirm_on_delete" }

- name: ranger settings in rifle.conf
  copy: src=rifle.conf dest={{ user_home }}/.config/ranger

- name: copy utility scripts
  copy:
    src: "{{ item }}"
    dest: "{{ user_home }}/bin"
    mode: "u=xrw,g=xr,o=xr"
  with_items:
  - tmux_edit.sh
  - pull_all_repos.sh

- name: set ssh key
  copy:
    src: "{{ item.src }}"
    dest: "{{ user_home }}/.ssh"
    mode: "{{ item.mode }}"
  with_items:
  - { src: id_rsa, mode: "u=rw,g-rwx,o-rwx" }
  - { src: id_rsa.pub, mode: "u=rw,g=r,o=r" }

- name: setup auto-updates
  become: true
  copy:
    src: auto-upgrade
    dest: /etc/cron.daily
    mode: "u=rwx,g=rx,o=rx"
