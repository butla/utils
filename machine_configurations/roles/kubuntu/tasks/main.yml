---
- name: switch compositor to opengl3.1
  lineinfile:
    dest: "{{ ansible_env.HOME }}/.config/kwinrc"
    line: GLCore=true
    regexp: '^GLCore='

- name: prevent tearing on pc
  when: not on_laptop
  become: true
  lineinfile:
    dest: /etc/profile.d/tearing.sh
    line: export KWIN_TRIPLE_BUFFER=1
    regexp: '^export KWIN_TRIPLE_BUFFER='
    create: yes

- name: set desktop konsole font size
  when: not on_laptop
  set_fact: konsole_font_size=10

- name: set laptop konsole font size
  when: on_laptop
  set_fact: konsole_font_size=11

- set_fact: konsole_conf_dir={{ ansible_env.HOME }}/.local/share/konsole

- name: set konsole profile
  template: src=Butla.profile dest={{ konsole_conf_dir }}

- name: set konsole settings
  copy: src=konsole/{{ item.src }} dest={{ item.dest }}
  with_items:
  - { src: Linux.colorscheme, dest: "{{ ansible_env.HOME }}/.local/share/konsole" }
  # this will report getting changed after system reboot
  - { src: konsolerc, dest: "{{ ansible_env.HOME }}/.config" }

- name: set custom shortcuts
  copy: src=khotkeysrc dest={{ ansible_env.HOME }}/.config

- name: modify global shortcuts
  lineinfile:
    dest: "{{ ansible_env.HOME }}/.config/kglobalshortcutsrc"
    line: "{{ item.line }}"
    regexp: "{{ item.regexp }}"
  with_items:
  # first three are getting changed by system at reboot, but they work fine...
  - { line: 'Lock Session=Meta+L,none,Lock Session', regexp: '^Lock Session=' }
  - { line: 'MoveZoomDown=none,none,Move Zoomed Area Downwards', regexp: '^MoveZoomDown=' }
  - { line: 'show dashboard=Meta+D,none,Show Desktop', regexp: '^show dashboard=' }
  - line: 'Walk Through Windows=Alt+Tab,none,Walk Through Windows'
    regexp: '^Walk Through Windows='
  - line: 'Walk Through Windows (Reverse)=Alt+Shift+Backtab,none,Walk Through Windows (Reverse)'
    regexp: '^Walk Through Windows \(Reverse\)='
  - { line: 'Window Maximize=Meta+Up,none,Maximize Window', regexp: '^Window Maximize=' }
  - { line: 'Window Minimize=Meta+Down,none,Minimize Window', regexp: '^Window Minimize=' }
  - line: 'Window Quick Tile Left=Meta+Left,none,Quick Tile Window to the Left'
    regexp: '^Window Quick Tile Left='
  - line: 'Window Quick Tile Right=Meta+Right,none,Quick Tile Window to the Right'
    regexp: '^Window Quick Tile Right='
  - line: 'Window to Next Screen=Meta+Shift+Left,none,Window to Next Screen'
    regexp: '^Window to Next Screen='
  - line: 'Window to Previous Screen=Meta+Shift+Right,none,Window to Previous Screen'
    regexp: '^Window to Previous Screen='
  - line: 'activate widget 2=Meta+Q,none,Activate Application Launcher Widget'
    regexp: '.*Activate Application Launcher Widget$'
  - line: 'manage activities=none,Meta+Q,Activities...'
    regexp: '^manage activities='

- set_fact: plasma_conf={{ ansible_env.HOME }}/.config/plasma-org.kde.plasma.desktop-appletsrc

- name: modify laucher hotkey
  command: >
    kwriteconfig5 --file {{ plasma_conf }}
    --group Containments --group 1 --group Applets --group 2 --group Shortcuts
    --key global Meta+Q

- name: set each session to start clean
  lineinfile:
    dest: "{{ ansible_env.HOME }}/.config/ksmserverrc"
    line: loginMode=default
    regexp: '^loginMode='

- name: hide communicator and korganizer in trey
  command: >
    kwriteconfig5 --file {{ plasma_conf }}
    --group Containments --group 1 --group Applets --group 5 --group Configuration --group General
    --key hiddenItems "org.kde.ktp-contactlist,KOrganizer Reminder Daemon"

- name: set clock appearance
  command: >
    kwriteconfig5 --file {{ plasma_conf }}
    --group Containments --group 1 --group Applets --group 6 --group Configuration --group Appearance
    --key {{ item.key }} {{ item.value }}
  with_items:
  - { key: boldText, value: 'true' }
  - { key: dateFormat, value: isoDate }
  - { key: showDate, value: 'true' }
  - { key: showSeconds, value: 'true' }

- name: set automatic mounting of removable media
  command: >
    kwriteconfig5 --file {{ ansible_env.HOME }}/.config/kded_device_automounterrc
    --group General--key AutomountEnabled true

- name: disable splash screen on laptop
  when: on_laptop
  command: >
    kwriteconfig5 --file {{ ansible_env.HOME }}/.config/ksplashrc
    --group KSplash --key {{ item.key }} {{ item.value }}
  with_items:
  - { key: Engine, value: 'none' }
  - { key: Theme, value: 'None' }

- name: set power management options
  command: >
    kwriteconfig5 --file {{ ansible_env.HOME }}/.config/powermanagementprofilesrc
    --group AC --group {{ item.group }} --key {{ item.key }} {{ item.value }}
  with_items:
  - { group: DPMSControl, key: idleTime, value: 720 }
  - { group: DimDisplay, key: idleTime, value: 600000 }
  - { group: SuspendSession, key: idleTime, value: 1200000 }
  - { group: SuspendSession, key: suspendType, value: 1 }

- name: set favourites menu
  command: >
    kwriteconfig5 --file {{ plasma_conf }}
    --group Containments --group 1 --group Applets --group 2 --group Configuration --group General
    --key favorites pycharm-community.desktop,keepass2.desktop,kde4-ktorrent.desktop

# it's normally Alt and it messes with Pycharm square selection
- name: set window control modifier button to meta
  ini_file:
    dest: "{{ ansible_env.HOME }}/.config/kwinrc"
    section: MouseBindings
    option: CommandAllKey
    value: Meta

- name: configure ktorrent
  ini_file:
    dest: "{{ ansible_env.HOME }}/.kde/share/config/ktorrentrc"
    section: downloads
    option: dhtSupport
    value: true

